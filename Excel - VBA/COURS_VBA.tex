\documentclass[a4paper,12pt]{report}
% il faut excecuter ce code en luatex 
% Encodage et langue
\usepackage{fontspec} 
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[french]{babel}
\usepackage{graphicx}

% Packages pour le style et la mise en page
\usepackage{listings}      % Insertion de code
\usepackage{xcolor}        % Couleurs
\usepackage{hyperref}      % Liens hypertexte
\usepackage{float}         % Placement des figures
\usepackage{fancyhdr}      % Personnalisation des en-têtes/pieds de page
\usepackage{mathptmx}      % Police Times avec maths
\usepackage{array}         % Colonnes étendues
\usepackage{multirow}      % Cellules multi-lignes
\usepackage{makecell}      % Cellules personnalisées
\setcellgapes{1pt}         % Espacement des cellules (si makecell est utilisé)

% Configuration de fancyhdr pour les en-têtes
\pagestyle{fancy}
\fancyhead[L]{Excel-VBA}
\fancyhead[R]{Université Paris-Est Créteil}
\fancyfoot[C]{\thepage}    % Pied de page avec le numéro de page

% Configuration pour le code VBA
\lstset{
	language=[Visual]Basic,
	basicstyle=\ttfamily\small,
	keywordstyle=\color{blue}\bfseries,
	stringstyle=\color{red},
	commentstyle=\color{green!50!black}\itshape,
	numbers=left,
	numberstyle=\tiny\color{gray},
	stepnumber=1,
	numbersep=10pt,
	frame=single,
	framerule=0.5pt,
	backgroundcolor=\color{gray!10},
	showspaces=false,
	showstringspaces=false,
	tabsize=4,
	captionpos=b,
	breaklines=true,            % Coupe automatiquement les lignes trop longues
	breakatwhitespace=true,     % Coupe uniquement aux espaces
	keepspaces=true,            % Conserve les espaces
	escapeinside={(*@}{@*)},    % Permet d’insérer du LaTeX dans le code
	morekeywords={End, Function, Sub} % Ajout des mots-clés spécifiques à VBA
}

\begin{document}
	
	
	\begin{titlepage}
		\centering
		\begin{center}
\includegraphics[scale = 0.3]{../../../Pictures/FAC_SEG_rvb}
					
		\end{center}
		\vspace*{2cm}
		\Huge
		
		\textbf{Excel-VBA}
		\vspace{1.5cm}
		
		\Large
		Cours intégral
		
		\vspace{2cm}
		
		\textbf{Issa KACHAOU} \\
		{\normalsize Délégué étudiant du M1 MBFA parcours Ingénierie Immobilière}
		
		
		\vfill
		
		\Large
		
		\textsc{\textbf{Université Paris Est-Créteil}}	 \\
		\textbf{Département d'économie} \\
		\textbf{2024}
		
	\end{titlepage}
	\thispagestyle{empty}
	\newpage
	\clearpage
	\mbox{}
	\thispagestyle{empty}
	
	\tableofcontents
	
	\thispagestyle{empty}
	\newpage
	\mbox{}
	\thispagestyle{empty} %Dernière page vide
	%\backmatter
	
\chapter{Les Bases des Macros et des Fonctions}
	
	\section{Introduction à VBA}
	VBA (Visual Basic for Applications) est un langage de programmation intégré dans les applications Microsoft (comme Excel, Word, etc.), qui permet d'automatiser des tâches et de créer des macros ou des fonctions personnalisées. Il est particulièrement utilisé dans Excel pour automatiser des calculs, manipuler des données ou créer des interfaces personnalisées.
	
	\section{Structure d'un Code VBA}
	Un code VBA est généralement constitué de deux éléments principaux : les \textbf{Subroutines} (ou macros) et les \textbf{Fonctions}.
	
	\subsection{Les Macros (Subroutines)}
	Une \textbf{macro} est une séquence d'instructions qui est exécutée lorsque vous l'appelez. Les macros sont généralement utilisées pour automatiser des tâches répétitives. Elles n'ont pas de valeur de retour, ce qui signifie qu'elles effectuent des actions sans renvoyer de résultat.
	\newpage
	\subsubsection*{Exemple de macro :}
	\begin{lstlisting}[caption=Macro simple]
		Sub macro1()
		MsgBox "Hello !!"
		
		'instruction1
		'instruction2
		End Sub
	\end{lstlisting}
	
	\begin{itemize}
		\item \textbf{Sub macro1()}: Cela définit une macro appelée \texttt{macro1}.
		\item \textbf{MsgBox "Hello !!"}: Cette instruction affiche une boîte de message avec le texte \texttt{"Hello !!"}.
		\item \textbf{'instruction1} et \textbf{'instruction2}: Ce sont des commentaires. En VBA, tout ce qui suit un apostrophe (\texttt{'}) est ignoré lors de l'exécution du code.
		\item \textbf{End Sub}: Cela marque la fin de la macro.
	\end{itemize}
	
	\subsection{Les Fonctions}
	Une \textbf{fonction} est similaire à une macro, mais elle permet de \textbf{retourner une valeur}. Les fonctions sont souvent utilisées pour effectuer des calculs ou manipuler des données et renvoyer un résultat. 
	
	\subsubsection*{Exemple de fonction :}
	\begin{lstlisting}[caption=Définition d'une fonction]
		Function mafonction1()
		'instruction1
		'instruction2
		End Function
	\end{lstlisting}
	\newpage
	Les fonctions peuvent également contenir des calculs, comme l'exemple ci-dessous :
	
	\begin{lstlisting}[caption=Fonction avec retour de valeur]
		Function addition(a As Integer, b As Integer) As Integer
		addition = a + b
		End Function
	\end{lstlisting}
	
	Cette fonction prend deux paramètres (\texttt{a} et \texttt{b}), les additionne, puis renvoie le résultat.
	
	\subsection{Différence entre \texttt{Sub} et \texttt{Function}}
	\begin{itemize}
		\item \textbf{Sub (Subroutine)}: Une procédure qui effectue des actions mais ne renvoie pas de valeur.
		\item \textbf{Function}: Une procédure qui peut effectuer des actions et qui renvoie une valeur.
	\end{itemize}
	
	\section{Comment Utiliser les Macros et les Fonctions}
	\subsection{Exécution d'une macro}
	Pour exécuter une \textbf{macro} dans Excel, vous pouvez :
	\begin{itemize}
		\item Lier la macro à un bouton.
		\item L'exécuter directement depuis l'éditeur VBA.
	\end{itemize}
	
	\subsection{Utilisation d'une fonction dans une cellule Excel}
	Une \textbf{fonction} peut être utilisée dans une cellule Excel, comme une fonction Excel standard. Par exemple, une fonction \texttt{addition} que vous avez définie peut être appelée dans une cellule de la manière suivante :
	
	\begin{verbatim}
		=addition(5, 10)
	\end{verbatim}
	
	Cela renverra le résultat de l'addition de 5 et 10, soit 15.
	
	\section{Résumé}
	\begin{itemize}
		\item \textbf{Sub}: Crée une macro qui exécute des actions mais ne renvoie pas de valeur.
		\item \textbf{Function}: Crée une fonction qui peut effectuer des actions et renvoyer une valeur.
		\item Les \textbf{commentaires} (lignes commençant par \texttt{'}) sont utilisés pour expliquer le code sans affecter son exécution.
	\end{itemize}
	
	\section{Conclusion}
	Le VBA est un outil puissant pour automatiser les tâches dans les applications Microsoft, comme Excel. Vous pouvez utiliser des \textbf{macros} pour exécuter des séries d'actions et des \textbf{fonctions} pour effectuer des calculs ou manipuler des données tout en renvoyant des résultats. Les commentaires dans le code sont essentiels pour documenter et clarifier les actions sans interférer avec l'exécution.
	
\chapter{Utilisation de la fonction MsgBox en VBA}

\section{Exemple simple de MsgBox}
La fonction \texttt{MsgBox} permet d'afficher une boîte de dialogue à l'utilisateur. Voici un exemple :

\begin{lstlisting}
	Sub bonjour()
	MsgBox "Bonjour ! Nous sommes le : " & Date
	'L'instruction Date nous donne la date du jour
	End Sub
\end{lstlisting}

\section{Personnalisation de MsgBox}
Vous pouvez personnaliser les boutons et les icônes de la boîte de dialogue. Exemple :

\begin{lstlisting}
	Sub bonjour_personnalise()
	MsgBox "Bonjour ! Nous sommes le : " & Date, vbYesNo + vbCritical, "Titre personnalisé
	End Sub
\end{lstlisting}

Dans cet exemple :
\begin{itemize}
	\item \texttt{vbYesNo} ajoute les boutons "Oui" et "Non".
	\item \texttt{vbCritical} affiche une icône d'alerte.
	\item Le titre de la boîte est défini par le troisième argument.
\end{itemize}

\section{Retour à la ligne dans MsgBox}
Pour insérer un retour à la ligne dans une boîte de dialogue, utilisez la fonction \texttt{Chr(10)} :

\begin{lstlisting}
	Sub msgbox_retour_ligne()
	MsgBox "Bonjour !" & Chr(10) & "Nous sommes le : " & Date, vbOKOnly, "Message structuré"
	End Sub
\end{lstlisting}

\section{Confirmation avec MsgBox}
Une autre utilisation fréquente de \texttt{MsgBox} est de demander une confirmation avant d'effectuer une action. Exemple :

\begin{lstlisting}
	Sub color()
	If MsgBox("Voulez-vous appliquer la couleur rouge à la cellule F2 ?", vbYesNo, "Confirmation") = vbYes Then
	Range("F2").Interior.Color = RGB(255, 0, 0)
	Else
	Range("F2").ClearFormats
	End If
	End Sub
\end{lstlisting}
\newpage
\section{Exemple avancé : Mise en couleur automatique}

Ce code applique des couleurs et des commentaires aux cellules d'une plage en fonction de leur valeur :

\begin{lstlisting}
	Sub applicouleur()
	If MsgBox("Voulez-vous appliquer la couleur et les commentaires ?", vbYesNo, "Confirmation") = vbNo Then
	Sheets("Feuil2").Range("B2:C13").Interior.Pattern = xlNone
	Sheets("Feuil2").Range("C2:C13").ClearContents
	Exit Sub
	End If
	
	For i = 2 To 13
	If Sheets("Feuil2").Range("B" & i).Value > 0 Then
	Sheets("Feuil2").Range("B" & i).Interior.Color = RGB(0, 255, 0) ' Vert
	Sheets("Feuil2").Range("C" & i).Value = "Positif"
	ElseIf Sheets("Feuil2").Range("B" & i).Value < 0 Then
	Sheets("Feuil2").Range("B" & i).Interior.Color = RGB(255, 0, 0) ' Rouge
	Sheets("Feuil2").Range("C" & i).Value = "Négatif"
	Else
	Sheets("Feuil2").Range("B" & i).Interior.Color = RGB(0, 0, 255) ' Bleu
	Sheets("Feuil2").Range("C" & i).Value = "Nul"
	End If
	Next i
	End Sub
\end{lstlisting}

\chapter{Gestion des erreurs et affichage des informations d'un pays}

Ce chapitre explore des concepts avancés en VBA liés à la gestion des erreurs, à l'interaction utilisateur via les \texttt{InputBox} et \texttt{MsgBox}, et à la manipulation de plages de données dans Excel.

\section{Théorie : Les notions abordées}

\subsection{La gestion des erreurs}

La gestion des erreurs en VBA permet de prévenir les plantages en cas d'entrée ou d'événement inattendu. L'instruction \texttt{On Error GoTo} redirige l'exécution vers un point spécifique du code lorsqu'une erreur survient.

\begin{itemize}
	\item \texttt{On Error GoTo [nom\_du\_label]} : Détermine le point d'entrée en cas d'erreur.
	\item \texttt{Resume Next} : Ignorer l'erreur et passer à l'instruction suivante.
	\item \texttt{Err.Number} : Donne le numéro de l'erreur rencontrée.
	\item \texttt{Err.Description} : Retourne une description de l'erreur.
\end{itemize}
\newpage
\textbf{Exemple : Gestion d'une erreur}
\begin{lstlisting}
	On Error GoTo erreur
	' Code risquant de générer une erreur
	
	Exit Sub ' Sortir pour éviter d'exécuter le label en l'absence d'erreur
	
	erreur:
	MsgBox "Une erreur est survenue : " & Err.Description, vbCritical
\end{lstlisting}

\subsection{Les interactions utilisateur}

Les interactions utilisateur en VBA se font souvent à l'aide des fonctions suivantes :

\begin{itemize}
	\item \textbf{\texttt{MsgBox}} : Affiche une boîte de message. Elle peut afficher des informations, poser des questions ou alerter l'utilisateur.
	\item \textbf{\texttt{InputBox}} : Permet de demander à l'utilisateur une entrée, qui sera ensuite traitée dans le programme.
\end{itemize}

\textbf{Paramètres principaux de \texttt{MsgBox} :}
\begin{itemize}
	\item \texttt{Prompt} : Le texte affiché dans la boîte.
	\item \texttt{Buttons} : Définit les boutons et icônes (ex. \texttt{vbYesNo}, \texttt{vbCritical}).
	\item \texttt{Title} : Spécifie le titre de la boîte.
\end{itemize}

\textbf{Exemple : Une boîte de message simple}
\begin{lstlisting}
	MsgBox "Ceci est un message d'information.", vbInformation, "Information"
\end{lstlisting}

\textbf{Paramètres principaux de \texttt{InputBox} :}
\begin{itemize}
	\item \texttt{Prompt} : Texte expliquant ce qui est attendu de l'utilisateur.
	\item \texttt{Title} : Titre de la boîte.
	\item \texttt{Default} : Valeur par défaut de l'entrée.
\end{itemize}

\textbf{Exemple : Demander une valeur numérique}
\begin{lstlisting}
	Dim valeur As Integer
	valeur = InputBox("Veuillez saisir un entier :", "Entrée de données", 0)
\end{lstlisting}

\subsection{La gestion des plages de données}

En VBA, les plages de données sont manipulées à l'aide de la méthode \texttt{Range}. Voici quelques concepts clés :
\begin{itemize}
	\item \textbf{\texttt{Range("A1")}} : Référence à une cellule spécifique.
	\item \textbf{\texttt{Range("A1:B10")}} : Référence à une plage.
	\item \textbf{\texttt{Interior.Color}} : Change la couleur de fond d'une cellule.
	\item \textbf{\texttt{Value}} : Récupère ou affecte une valeur à une cellule.
\end{itemize}

\textbf{Exemple : Appliquer une couleur à une cellule}
\begin{lstlisting}
	Range("A1").Interior.Color = RGB(255, 0, 0) ' Rouge
\end{lstlisting}

\section{Exemples pratiques avec explications}

\subsection{Exemple 1 : Gestion des erreurs avec \texttt{TypeVal}}

Le code ci-dessous montre comment demander une valeur numérique à l'utilisateur et gérer les erreurs de saisie.

\begin{lstlisting}
	Sub TypeVal()
	
	' En cas d'erreur, aller au message d'alerte
	On Error GoTo msg_erreur
	
	' Définir la variable
	Dim VarNum As Integer
	
	' Saisie de l'utilisateur
	VarNum = InputBox("Veuillez saisir une valeur numérique", _
	"Type variable", 0)
	
	' Affectation de la valeur à une cellule
	Sheets("Feuil1").Range("B3").Value = VarNum
	
	Exit Sub
	
	msg_erreur:
	MsgBox "Erreur : saisie non numérique. Veuillez réessayer.", _
	vbCritical, "Alerte"
	Call TypeVal ' Relance la procédure
	End Sub
\end{lstlisting}

\textbf{Analyse :}
\begin{itemize}
	\item Si l'utilisateur saisit une valeur invalide, le message d'alerte s'affiche et l'utilisateur doit réessayer.
	\item La valeur est ensuite insérée dans la cellule \texttt{B3}.
\end{itemize}

\subsection{Exemple 2 : Affichage des informations d'un pays}

Ce code permet d'afficher des informations spécifiques à un pays sélectionné par l'utilisateur dans une feuille Excel.

\begin{lstlisting}
	Sub FichePays()
	
	Dim NumPays As Integer
	Dim sh As Worksheet
	
	On Error GoTo msg_erreur
	
	Set sh = Sheets("DATA")
	NumPays = InputBox("Veuillez saisir un entier entre 2 et 6", _
	"Sélection du pays", 2)
	
	If NumPays >= 2 And NumPays <= 6 Then
	MsgBox "Pays : " & sh.Range("A" & NumPays).Value & Chr(10) & _
	"Capitale : " & sh.Range("B" & NumPays).Value, vbInformation
	Else
	GoTo msg_erreur
	End If
	
	Exit Sub
	
	msg_erreur:
	MsgBox "Erreur : valeur invalide. Veuillez réessayer.", vbCritical, "Alerte"
	Call FichePays
	End Sub
\end{lstlisting}

\textbf{Analyse :}
\begin{itemize}
	\item L'utilisateur doit sélectionner un numéro correspondant à un pays dans la plage 2 à 6.
	\item Les informations du pays sont extraites de la feuille \texttt{DATA} et affichées dans une boîte de message.
	\item Si la saisie est incorrecte, une alerte s'affiche, et la procédure est relancée.
\end{itemize}

\section{Conclusion}

Ces exemples montrent comment gérer les interactions utilisateur et les erreurs dans un programme VBA. Les notions de \texttt{InputBox}, \texttt{MsgBox}, et de gestion des plages permettent de créer des applications interactives robustes. En combinant ces concepts, il est possible d'améliorer la fiabilité et l'expérience utilisateur des macros VBA.
	
\chapter{Introduction aux Variables en VBA}

\section{Déclaration des Variables et Portée}
En VBA, la \textbf{portée} des variables détermine où celles-ci sont accessibles dans le code :
\begin{itemize}
	\item \textbf{Variables locales :} Déclarées dans une procédure (\texttt{Sub}), elles ne sont accessibles qu'à l'intérieur de cette procédure.
	\item \textbf{Variables globales :} Déclarées au début du module, elles sont accessibles dans toutes les procédures de ce module.
\end{itemize}

\subsection*{Exemple}
\begin{lstlisting}
	Dim x As Integer
	
	Sub macro1()
	' x est disponible ici
	Dim y As Integer
	' y est disponible uniquement ici
	End Sub
	
	Sub macro2()
	' x est disponible ici
	End Sub
\end{lstlisting}

Dans cet exemple :
\begin{itemize}
	\item \texttt{x} est une variable globale, accessible dans \texttt{macro1} et \texttt{macro2}.
	\item \texttt{y} est une variable locale, accessible uniquement dans \texttt{macro1}.
\end{itemize}

\section{Variables à Longueur Fixe}
VBA permet de déclarer des variables de longueur fixe pour limiter la quantité de mémoire utilisée.
\begin{lstlisting}
	Sub TestVar()
	Dim Tvar As String * 4 ' Longueur fixe à 4 caractères
	Dim sh As Worksheet
	Dim cel As Range
	
	' Affecter une valeur via une boîte de dialogue
	Set sh = Worksheets("Feuil1")
	Set cel = sh.Range("B2")
	Tvar = InputBox("Veuillez saisir une valeur", "Test variable")
	
	' Stocker la valeur dans une cellule
	cel.Value = Tvar
	MsgBox Len(Tvar) ' Nombre de caractères
	End Sub
\end{lstlisting}

Cet exemple montre :
\begin{itemize}
	\item La déclaration d'une variable \texttt{Tvar} avec une longueur maximale de 4 caractères.
	\item L'utilisation de \texttt{InputBox} pour récupérer une valeur saisie par l'utilisateur.
	\item L'affichage de la longueur de la chaîne avec la fonction \texttt{Len}.
\end{itemize}

\section{Option Explicit}
La directive \texttt{Option Explicit} est utilisée dans VBA pour obliger la déclaration explicite de toutes les variables avant leur utilisation dans le code. Cela signifie que chaque variable doit être déclarée à l'aide de la commande \texttt{Dim}, \texttt{Private}, ou \texttt{Public}, et une tentative d'utiliser une variable non déclarée entraînera une erreur de compilation.

Cette pratique est recommandée car elle permet de détecter les erreurs liées aux fautes de frappe dans les noms de variables, ce qui peut être difficile à repérer autrement. De plus, l'utilisation de \texttt{Option Explicit} rend le code plus lisible et prévient des comportements inattendus dus à l'utilisation de variables non définies.

\subsection{Exemple}

Voici un exemple de code avec \texttt{Option Explicit} activée :

\begin{lstlisting}[language=VBScript]
	Option Explicit
	
	Sub ExempleOptionExplicit()
	Dim x As Integer
	x = 10
	y = 5  ' Erreur : la variable 'y' n'est pas déclarée
	End Sub
\end{lstlisting}

Dans cet exemple, la tentative d'utiliser la variable \texttt{y} sans l'avoir déclarée provoque une erreur de compilation. Si \texttt{Option Explicit} n'était pas activé, \texttt{y} aurait été automatiquement créée comme variable de type \texttt{Variant}, ce qui pourrait entraîner des erreurs difficiles à déboguer plus tard.

\subsection{Avantages}
\begin{itemize}
	\item \texttt{Option Explicit} permet de réduire les erreurs liées aux variables mal déclarées.
	\item Elle rend le code plus propre et plus facile à maintenir.
	\item Elle aide à identifier rapidement les erreurs lors de la compilation, plutôt que lors de l'exécution du code.
\end{itemize}


\chapter{Les Boucles \texttt{For} et \texttt{While}}

\section{Introduction}
Les boucles permettent d'exécuter une séquence d'instructions plusieurs fois, selon une condition ou une plage de valeurs. En VBA, les boucles les plus courantes sont :
\begin{itemize}
	\item \texttt{For ... Next} : utilisée pour itérer sur une plage définie de valeurs.
	\item \texttt{Do While ... Loop} : utilisée pour répéter une série d'instructions tant qu'une condition est vraie.
\end{itemize}

\section{La Boucle \texttt{For}}
La boucle \texttt{For} est utilisée lorsque le nombre d'itérations est connu à l'avance.

\subsection*{Structure Théorique}
\begin{lstlisting}
	For [Variable] = [ValeurDépart] To [ValeurFin] [Step [Incrément]]
	' Instructions à exécuter
	Next [Variable]
\end{lstlisting}

\begin{itemize}
	\item \textbf{Variable :} La variable utilisée pour contrôler la boucle.
	\item \textbf{ValeurDépart :} La valeur initiale de la variable.
	\item \textbf{ValeurFin :} La valeur finale à atteindre.
	\item \textbf{Step :} (Optionnel) Définit l'incrément ou le décrément. Par défaut, il vaut 1.
\end{itemize}

\subsection*{Exemple : Parcourir une Plage de Cellules}
\begin{lstlisting}
	Sub ExempleFor()
	Dim i As Integer
	Dim sh As Worksheet
	Set sh = Worksheets("Feuil1")
	
	For i = 1 To 10
	sh.Cells(i, 1).Value = "Ligne " & i
	Next i
	End Sub
\end{lstlisting}

Dans cet exemple :
\begin{itemize}
	\item La boucle \texttt{For} parcourt les lignes 1 à 10 de la feuille \texttt{Feuil1}.
	\item La cellule de chaque ligne dans la colonne A reçoit la valeur \texttt{"Ligne X"}, où \texttt{X} correspond au numéro de la ligne.
\end{itemize}

\subsection*{Exemple avec \texttt{Step}}
\begin{lstlisting}
	Sub ExempleForStep()
	Dim i As Integer
	For i = 1 To 10 Step 2
	Debug.Print "Valeur : " & i
	Next i
	End Sub
\end{lstlisting}

Ici, l'instruction \texttt{Step 2} incrémente la variable de 2, ce qui donne comme valeurs successives : 1, 3, 5, 7, 9.

\section{La Boucle \texttt{Do While}}
La boucle \texttt{Do While} répète une série d'instructions tant qu'une condition reste vraie.

\subsection*{Structure Théorique}
\begin{lstlisting}
	Do While [Condition]
	' Instructions à exécuter
	Loop
\end{lstlisting}

\begin{itemize}
	\item \textbf{Condition :} Une expression logique ou une comparaison. La boucle s'exécute tant que cette condition est vraie.
\end{itemize}

\subsection*{Exemple : Addition jusqu'à une Limite}
\begin{lstlisting}
	Sub ExempleWhile()
	Dim somme As Integer
	Dim i As Integer
	somme = 0
	i = 1
	
	Do While somme < 20
	somme = somme + i
	i = i + 1
	Loop
	
	MsgBox "Somme finale : " & somme
	End Sub
\end{lstlisting}

Dans cet exemple :
\begin{itemize}
	\item La boucle continue tant que la somme des nombres ajoutés est inférieure à 20.
	\item Une boîte de message affiche la somme finale une fois la boucle terminée.
\end{itemize}

\section{Comparaison entre \texttt{For} et \texttt{Do While}}
\begin{itemize}
	\item \textbf{Utilisez \texttt{For} :} lorsque le nombre d'itérations est défini ou déterminable à l'avance.
	\item \textbf{Utilisez \texttt{Do While} :} lorsque vous devez continuer à itérer jusqu'à ce qu'une certaine condition soit remplie.
\end{itemize}
\newpage
\section{Exemple Combiné : \texttt{For} et \texttt{Do While}}
\begin{lstlisting}
	Sub ExempleCombine()
	Dim i As Integer
	Dim somme As Integer
	somme = 0
	
	For i = 1 To 10
	If somme >= 15 Then
	Exit For ' Arrête la boucle si la somme atteint 15
	End If
	somme = somme + i
	Next i
	
	MsgBox "Somme finale : " & somme
	End Sub
\end{lstlisting}

Cet exemple illustre :
\begin{itemize}
	\item Une boucle \texttt{For} qui s'arrête prématurément à l'aide de \texttt{Exit For}.
	\item Une condition pour limiter la somme calculée.
\end{itemize}

\section{Bonnes Pratiques}
\begin{itemize}
	\item Limitez les boucles imbriquées pour éviter des performances dégradées et des codes difficiles à lire.
	\item Utilisez \texttt{Exit For} ou \texttt{Exit Do} pour interrompre une boucle lorsqu'une condition est remplie.
	\item Assurez-vous que la condition d'arrêt dans une boucle \texttt{Do While} est toujours atteinte pour éviter des boucles infinies.
\end{itemize}

\section{Conclusion}
Les boucles \texttt{For} et \texttt{While} sont essentielles pour automatiser les tâches répétitives en VBA. Elles permettent de parcourir des données, effectuer des calculs ou appliquer des formats de manière efficace. Leur utilisation judicieuse est un atout pour optimiser les performances et la lisibilité du code.



\chapter{L'instruction \texttt{With ... End With}}

\section{Introduction}
L'instruction \texttt{With ... End With} permet de simplifier et d'optimiser le code lorsqu'on effectue plusieurs opérations sur le même objet. Elle évite de répéter l'identification de l'objet pour chaque propriété ou méthode que vous souhaitez utiliser, rendant le code plus clair et plus rapide à exécuter.

\section{Syntaxe}
La syntaxe générale est la suivante :
\begin{lstlisting}
	With [Objet]
	.Propriété1 = Valeur1
	.Propriété2 = Valeur2
	.Méthode
	End With
\end{lstlisting}
\begin{itemize}
	\item \textbf{[Objet]} : L'objet sur lequel vous travaillez.
	\item \textbf{Propriété1, Propriété2, etc.} : Les propriétés que vous souhaitez modifier.
	\item \textbf{Méthode} : Les méthodes de l'objet que vous souhaitez appeler.
\end{itemize}
\newpage
\section{Exemple de Base}
Voici un exemple simple d'utilisation pour mettre en forme une plage de cellules :
\begin{lstlisting}
	Sub MiseEnForme()
	With Worksheets("Feuil1").Range("A1:D5").Font
	.Name = "Arial"
	.Size = 12
	.Bold = True
	.Color = RGB(255, 0, 0) ' Rouge
	End With
	End Sub
\end{lstlisting}

Dans cet exemple, la plage de cellules \texttt{A1:D5} sur la feuille \texttt{Feuil1} est formatée avec :
\begin{itemize}
	\item La police définie sur \texttt{Arial}.
	\item Une taille de 12 points.
	\item Un style gras.
	\item Une couleur rouge.
\end{itemize}

\section{Avantages}
\begin{itemize}
	\item \textbf{Lisibilité :} Le code est plus lisible car il élimine la répétition des références à l'objet.
	\item \textbf{Performance :} L'objet est évalué une seule fois, ce qui peut améliorer les performances pour des objets complexes.
	\item \textbf{Facilité de maintenance :} Si l'objet doit être changé, il suffit de modifier une seule ligne.
\end{itemize}
\newpage
\section{Exemple avec des Objets Multiples}
L'instruction \texttt{With ... End With} peut être utilisée de manière imbriquée pour travailler avec plusieurs objets :
\begin{lstlisting}
	Sub FormatMultiple()
	With Worksheets("Feuil1")
	With .Range("A1:D5")
	.Interior.Color = RGB(200, 200, 255) ' Couleur de fond
	.Font.Bold = True
	End With
	.Range("A1").Value = "Titre"
	End With
	End Sub
\end{lstlisting}

Ici :
\begin{itemize}
	\item Le formatage est appliqué à la plage \texttt{A1:D5}.
	\item La cellule \texttt{A1} reçoit une valeur.
\end{itemize}

\section{Bonnes Pratiques}
\begin{itemize}
	\item Utilisez \texttt{With ... End With} uniquement si vous effectuez plusieurs opérations sur le même objet.
	\item Veillez à ne pas imbriquer trop de blocs \texttt{With}, car cela peut rendre le code difficile à lire.
	\item Combinez \texttt{With ... End With} avec des commentaires clairs pour indiquer ce que chaque section fait.
\end{itemize}
\newpage
\section{Exemple Complet : Mise en Forme et Valeurs}
\begin{lstlisting}
	Sub ExempleComplet()
	With Worksheets("Feuil1")
	' Appliquer des propriétés de mise en forme
	With .Range("A1:D1").Font
	.Name = "Verdana"
	.Bold = True
	.Size = 14
	End With
	
	' Insérer des valeurs
	.Range("A1").Value = "Produit"
	.Range("B1").Value = "Prix"
	.Range("C1").Value = "Quantité"
	.Range("D1").Value = "Total"
	End With
	End Sub
\end{lstlisting}

Cet exemple montre comment :
\begin{itemize}
	\item Formater les en-têtes (\texttt{A1:D1}).
	\item Insérer des valeurs dans les cellules \texttt{A1}, \texttt{B1}, \texttt{C1}, et \texttt{D1}.
\end{itemize}

\section{Conclusion}
L'instruction \texttt{With ... End With} est une fonctionnalité essentielle pour simplifier, clarifier et optimiser le code VBA. Elle est particulièrement utile dans les projets où de nombreux objets doivent être manipulés de manière répétitive.


\chapter{Manipulation de Données}

\section{Calculs et Opérations de Base}
\begin{lstlisting}
	Sub test()
	Dim alpha As Integer, beta As Integer
	alpha = 6
	beta = 3
	
	Cells(1, 1).Value = alpha + beta
	MsgBox alpha + beta
	End Sub
\end{lstlisting}
Cet exemple montre comment effectuer des calculs simples et afficher les résultats dans une cellule et une boîte de message.
\newpage
\section{Formatage et Boucles}
\begin{lstlisting}
	Sub FormatNBoucle()
	Dim sh As Worksheet, i As Integer
	Set sh = Worksheets("Feuil1")
	
	For i = 2 To 5
	If Trim(LCase(sh.Range("D" & i).Value)) = "eur" Then
	sh.Range("E" & i).NumberFormat = "###,###,##0.00 €"
	ElseIf Trim(UCase(sh.Range("D" & i).Value)) = "GBP" Then
	sh.Range("E" & i).NumberFormat = "£ ###,###,##0.00"
	ElseIf Trim(UCase(sh.Range("D" & i).Value)) = "YEN" Then
	sh.Range("E" & i).NumberFormat = "¥ ###,###,##0.00"
	Else
	sh.Range("E" & i).NumberFormat = "###,###,##0.00"
	End If
	Next i
	End Sub
\end{lstlisting}

Cet exemple montre comment :
\begin{itemize}
	\item Utiliser une boucle \texttt{For} pour parcourir plusieurs cellules.
	\item Formater des valeurs numériques selon une devise (EUR, GBP, YEN).
	\item Manipuler des chaînes avec les fonctions \texttt{Trim}, \texttt{LCase} et \texttt{UCase}.
\end{itemize}

\chapter{Fonctions Personnalisées et Boucles}

\section{Fonctions Personnalisées}
\begin{lstlisting}
	Function indice(cours As Integer)
	indice = IIf(cours > 1000, "Croissant", "Décroissant")
	End Function
	
	Function CmNote(note As Integer)
	CmNote = IIf(note < 8, "Faible", IIf(note < 10, "Moyen", IIf(note < 15, "Bien", "Excellent")))
	End Function
\end{lstlisting}

Les fonctions personnalisées permettent de simplifier des calculs ou des classifications répétées. Dans cet exemple :
\begin{itemize}
	\item \texttt{indice} renvoie une chaîne selon la valeur d'une variable.
	\item \texttt{CmNote} évalue une note et renvoie un texte correspondant.
	
\end{itemize}
\newpage
\section{Procédure avec Boucles}
\begin{lstlisting}
	Sub CmtBoucle()
	Dim sh As Worksheet, i As Integer, DerL As Integer
	Set sh = Worksheets("Feuil2")
	DerL = sh.Cells(1, 1).End(xlDown).Row
	
	For i = 2 To DerL
	If sh.Cells(i, 2).Value < 8 Then
	sh.Cells(i, 7).Value = "Faible"
	ElseIf sh.Cells(i, 2).Value < 10 Then
	sh.Cells(i, 7).Value = "Moyen"
	ElseIf sh.Cells(i, 2).Value < 15 Then
	sh.Cells(i, 7).Value = "Bien"
	Else
	sh.Cells(i, 7).Value = "Excellent"
	End If
	Next i
	End Sub
\end{lstlisting}

Cette procédure évalue des notes et attribue un commentaire (faible, moyen, bien, excellent) dans une colonne correspondante.

\chapter{Mise en Forme}

\begin{lstlisting}
	Sub mise_en_forme()
	With Worksheets(1).Range("ma_plage1").Font
	.Name = "Arial"
	.Bold = True
	.Italic = True
	End With
	End Sub
\end{lstlisting}

Ce code montre comment appliquer des styles (gras, italique, police) à une plage de cellules avec la structure \texttt{With...End With}.

\chapter{Fonctions, Méthodes et Boucles en VBA}

Dans ce chapitre, nous allons explorer différentes fonctions intégrées dans VBA ainsi que les structures de boucles. Ces notions permettent de rendre les macros plus interactives et puissantes.

\section{Fonctions Intégrées dans VBA}

\subsection{Fonction \texttt{InStr}}
La fonction \texttt{InStr} retourne la position d'une chaîne de caractères dans une autre chaîne. Elle est très utile pour rechercher un caractère ou une sous-chaîne dans une chaîne donnée.

\begin{lstlisting}[caption=Exemple de fonction InStr]
	Sub InsTrt()
	
	MsgBox InStr(1, "test_insTr", "T", 1)
	
	' Le premier argument est la position de départ.
	' "T" est le caractère recherché.
	' 1 signifie que la recherche n'est pas sensible à la casse.
	
	End Sub
\end{lstlisting}

\subsection{Fonction \texttt{Chr}}
La fonction \texttt{Chr} retourne le caractère correspondant à un code ASCII donné. Cela permet de manipuler directement les caractères.

\begin{lstlisting}[caption=Exemple de fonction Chr]
	Sub ChrT()
	
	MsgBox Chr(98) ' Affiche le caractère correspondant au code ASCII 98 (b).
	
	End Sub
\end{lstlisting}

\subsection{Fonctions de gestion des dates}

VBA propose plusieurs fonctions pour manipuler les dates et heures :

\begin{itemize}
	\item \texttt{Date} : retourne la date actuelle.
	\item \texttt{Now} : retourne la date et l'heure actuelles.
	\item \texttt{Time} : retourne uniquement l'heure actuelle.
	\item \texttt{DateAdd} : ajoute un intervalle de temps à une date donnée.
\end{itemize}

\begin{lstlisting}[caption=Exemples de fonctions de gestion des dates]
	Sub dateT()
	
	MsgBox Date    ' Affiche la date actuelle.
	MsgBox Now     ' Affiche la date et l'heure actuelles.
	MsgBox Time    ' Affiche uniquement l'heure actuelle.
	
	End Sub
	
	Sub dateAddT()
	
	MsgBox DateAdd("m", 1, Date)    ' Ajoute un mois à la date actuelle.
	MsgBox DateAdd("d", 1, Date)    ' Ajoute un jour à la date actuelle.
	MsgBox DateAdd("yyyy", 1, Date) ' Ajoute un an à la date actuelle.
	
	End Sub
\end{lstlisting}

\subsection{Fonction \texttt{Round}}
La fonction \texttt{Round} permet d'arrondir un nombre à un certain nombre de décimales.

\begin{lstlisting}[caption=Exemple de fonction Round]
	Sub RoundT()
	
	Dim x As Double, y As Double
	
	x = 3.1458917417
	y = Round(x, 3) ' Arrondit à 3 décimales.
	
	MsgBox y ' Affiche 3.146.
	
	End Sub
\end{lstlisting}

\subsection{La méthode \texttt{Offset} en VBA}

La méthode \texttt{Offset} en VBA est utilisée pour accéder à des cellules en fonction de leur position relative par rapport à une cellule de départ. Elle est particulièrement utile pour parcourir des plages de données dynamiquement, sans avoir besoin de spécifier les coordonnées exactes.

\subsection*{Syntaxe}
\begin{verbatim}
	Range.Offset(Ligne, Colonne)
\end{verbatim}

\begin{itemize}
	\item \textbf{Ligne} : Nombre de lignes à se déplacer à partir de la cellule de départ.
	\begin{itemize}
		\item Valeur positive : déplacement vers le bas.
		\item Valeur négative : déplacement vers le haut.
	\end{itemize}
	\item \textbf{Colonne} : Nombre de colonnes à se déplacer à partir de la cellule de départ.
	\begin{itemize}
		\item Valeur positive : déplacement vers la droite.
		\item Valeur négative : déplacement vers la gauche.
	\end{itemize}
\end{itemize}
\newpage
\subsection*{Exemples d'utilisation}
\textbf{Exemple 1 : Accéder à une cellule spécifique}
\begin{lstlisting}[language=vbscript, caption={Accès à une cellule spécifique}]
	Sub ExempleOffset()
	
	Dim c As Range
	
	' Définir la cellule de départ
	Set c = Range("A1")
	
	' Accéder à une cellule 2 lignes en dessous et 1 colonne à droite
	c.Offset(2, 1).Value = "Bonjour VBA!"
	
	End Sub
\end{lstlisting}

Dans cet exemple, la cellule de départ est \texttt{A1}. La méthode \texttt{Offset(2, 1)} permet de se déplacer de 2 lignes vers le bas et 1 colonne vers la droite, ce qui correspond à la cellule \texttt{B3}.

\textbf{Exemple 2 : Parcourir une plage de cellules}
\begin{lstlisting}[language=vbscript, caption={Parcourir une plage avec \texttt{Offset}}]
	Sub ParcoursAvecOffset()
	
	Dim c As Range
	
	' Début à la cellule A1
	Set c = Range("A1")
	
	' Parcourir 10 lignes vers le bas
	Do Until c.Row > 10
	c.Value = "Ligne " & c.Row  ' Insérer un texte dans chaque cellule
	Set c = c.Offset(1, 0)      ' Passer à la cellule de la ligne suivante
	Loop
	
	End Sub
\end{lstlisting}

Ici, la boucle commence à \texttt{A1} et parcourt les 10 premières lignes. À chaque itération, la méthode \texttt{Offset(1, 0)} déplace la cellule courante d'une ligne vers le bas.

\subsection{Autres fonctions utiles}
\begin{itemize}
	\item \texttt{IsEmpty} : vérifie si une cellule est vide.
	\item \texttt{IsNumeric} : vérifie si une cellule contient une valeur numérique.
\end{itemize}

\begin{lstlisting}[caption=Exemple de fonctions IsEmpty et IsNumeric]
	Sub VideT()
	
	MsgBox IsEmpty(Range("A2"))   ' Vrai si la cellule A2 est vide.
	MsgBox IsNumeric(Range("A2")) ' Vrai si la cellule A2 contient un nombre.
	
	End Sub
\end{lstlisting}

\section{Les Boucles en VBA}

Les boucles permettent d'exécuter des instructions de manière répétée jusqu'à ce qu'une condition soit remplie.

\subsection{Boucle \texttt{While...Wend}}
Cette boucle exécute les instructions tant qu'une condition donnée est vraie.

\begin{lstlisting}[caption=Exemple de boucle While...Wend]
	Sub MdP()
	
	Dim psw As String
	
	While psw <> "12345"
	psw = InputBox("Mot de passe ?", "Mot de passe")
	Wend
	
	MsgBox "Mot de passe correct !"
	
	End Sub
\end{lstlisting}

\subsection{Boucle \texttt{Do Until...Loop}}
La boucle \texttt{Do Until} s'exécute jusqu'à ce qu'une condition soit vraie.

\begin{lstlisting}[caption=Exemple de boucle Do Until...Loop]
	Sub ShortLong()
	
	Dim c As Range
	Dim sh As Worksheet
	Set sh = Sheets(8)
	
	' Début de la boucle
	Set c = sh.Range("A2")
	
	Do Until c.Value = ""
	If c.Offset(0, 1).Value > 0 Then
	c.Offset(0, 2).Value = "LONG"
	c.Offset(0, 2).Font.Color = RGB(0, 255, 0)
	ElseIf c.Offset(0, 1).Value < 0 Then
	c.Offset(0, 2).Value = "SHORT"
	c.Offset(0, 2).Font.Color = RGB(255, 0, 0)
	Else
	c.Offset(0, 2).Value = "null"
	c.Offset(0, 2).Font.Color = RGB(0, 0, 255)
	End If
	Set c = c.Offset(1, 0)
	Loop
	
	End Sub
\end{lstlisting}
\newpage
\subsection{Boucle \texttt{For Each...Next}}
Cette boucle permet de parcourir chaque élément d'une collection.

\begin{lstlisting}[caption=Exemple de boucle For Each...Next]
	Sub LongShortF()
	
	Dim cel As Range, sh As Worksheet, Derlig As Integer
	
	Set sh = Sheets(8)
	Derlig = sh.Range("A1").End(xlDown).Row
	
	For Each cel In sh.Range("A2:A" & Derlig)
	If cel.Offset(0, 1).Value > 0 Then
	cel.Offset(0, 2).Value = "LONG"
	cel.Offset(0, 2).Font.Color = RGB(0, 255, 0)
	ElseIf cel.Offset(0, 1).Value < 0 Then
	cel.Offset(0, 2).Value = "SHORT"
	cel.Offset(0, 2).Font.Color = RGB(255, 0, 0)
	Else
	cel.Offset(0, 2).Value = "null"
	cel.Offset(0, 2).Font.Color = RGB(0, 0, 255)
	End If
	Next
	
	End Sub
\end{lstlisting}

\chapter{Réinitialisation de données avec les méthodes \texttt{Clear}}

En VBA, les méthodes \texttt{Clear}, \texttt{ClearContents} et \texttt{ClearFormats} sont utilisées pour réinitialiser ou effacer des données dans une plage de cellules. Ces méthodes permettent de supprimer soit les données, soit les formats, ou les deux.

\section{Méthodes principales de \texttt{Clear}}

\begin{itemize}
	\item \textbf{\texttt{ClearContents}} : Efface uniquement le contenu des cellules, mais conserve les formats (couleurs, bordures, etc.).
	\item \textbf{\texttt{ClearFormats}} : Efface uniquement les formats des cellules, mais conserve leur contenu.
	\item \textbf{\texttt{Clear}} : Efface à la fois le contenu et les formats des cellules.
\end{itemize}

\subsection*{Syntaxe}
\begin{verbatim}
	Range.ClearContents
	Range.ClearFormats
	Range.Clear
\end{verbatim}

\section{Exemple pratique}

Voici un exemple d'utilisation combinée de ces méthodes pour réinitialiser une colonne de données dans une feuille de calcul.
\newpage
\begin{lstlisting}[language=vbscript, caption={Exemple de réinitialisation avec \texttt{Clear}}]
	Sub ReInit()
	
	Dim DerL As Integer
	Dim sh As Worksheet
	
	' Affecter des valeurs aux variables
	Set sh = Worksheets(7)
	DerL = sh.Cells(1, 1).End(xlDown).Row
	
	' Réinitialiser les colonnes de C2 à la dernière ligne remplie
	sh.Range("C2:C" & DerL).ClearContents  ' Efface le contenu
	sh.Range("C2:C" & DerL).ClearFormats  ' Efface les formats
	sh.Range("C2:C" & DerL).Clear         ' Efface contenu + formats
	
	End Sub
\end{lstlisting}

\subsection*{Explications détaillées}

\begin{itemize}
	\item \textbf{Déclaration des variables :}
	\begin{itemize}
		\item \texttt{DerL} : Variable qui détermine la dernière ligne non vide de la colonne \texttt{A}.
		\item \texttt{sh} : Objet représentant la feuille de calcul numéro 7.
	\end{itemize}
	\item \textbf{Détection de la dernière ligne remplie :}
	\begin{lstlisting}[language=vbscript]
		DerL = sh.Cells(1, 1).End(xlDown).Row
	\end{lstlisting}
	Cette ligne utilise \texttt{End(xlDown)} pour détecter la dernière cellule non vide à partir de la cellule \texttt{A1}.
	\item \textbf{Effacement ciblé :}
	\begin{itemize}
		\item \texttt{ClearContents} supprime uniquement les valeurs de la plage \texttt{C2:C\&DerL}.
		\item \texttt{ClearFormats} supprime uniquement les formats de la plage.
		\item \texttt{Clear} combine les deux opérations.
	\end{itemize}
\end{itemize}

\section{Applications pratiques}

Ces méthodes sont particulièrement utiles pour :
\begin{itemize}
	\item Réinitialiser une plage de données avant une nouvelle saisie.
	\item Supprimer des formats appliqués par erreur tout en conservant les données.
	\item Nettoyer des feuilles de calcul en préparation d'une nouvelle analyse.
\end{itemize}

\chapter{Manipulation de texte avec \texttt{Mid}, \texttt{Len}, \texttt{Left}, et \texttt{Right}}

Ce chapitre explore diverses fonctions VBA utilisées pour manipuler des chaînes de caractères, en particulier lorsqu'il s'agit de nettoyer ou de transformer des données textuelles dans une feuille Excel.

\section{Présentation des fonctions}

\begin{itemize}
	\item \textbf{\texttt{Mid}} : Extrait une sous-chaîne d'une chaîne à partir d'une position donnée.
	\begin{itemize}
		\item \texttt{Mid(chaine, départ, longueur)}
	\end{itemize}
	\item \textbf{\texttt{Len}} : Renvoie la longueur totale d'une chaîne.
	\item \textbf{\texttt{Left}} : Extrait les premiers caractères d'une chaîne.
	\begin{itemize}
		\item \texttt{Left(chaine, longueur)}
	\end{itemize}
	\item \textbf{\texttt{Right}} : Extrait les derniers caractères d'une chaîne.
	\begin{itemize}
		\item \texttt{Right(chaine, longueur)}
	\end{itemize}
\end{itemize}

\section{Exemple pratique}

L'exemple suivant montre comment utiliser ces fonctions pour modifier des chaînes de texte en fonction de conditions spécifiques, telles que la présence d'un préfixe \texttt{"X\_"} ou une longueur excessive.
\newpage
\begin{lstlisting}[language=vbscript, caption={Exemple avec \texttt{Left}, \texttt{Right}, \texttt{Mid}, et \texttt{Len}}]
	Sub CleanText()
	
	Dim cel As Range, sh As Worksheet
	Set sh = Worksheets(1)
	
	For Each cel In sh.Range("A1:A10") ' Parcourt les cellules de la colonne A
	
	' Condition 1 : Si la chaîne commence par "X_"
	If Left(cel.Value, 2) = "X_" Then
	cel.Value = Right(cel.Value, Len(cel.Value) - 2)
	End If
	
	' Condition 2 : Si la chaîne contient plus de 7 caractères
	If Len(cel.Value) > 7 Then
	cel.Value = Right(cel.Value, Len(cel.Value) - 2)
	End If
	
	Next cel
	
	End Sub
\end{lstlisting}

\subsection*{Explications détaillées}

\begin{itemize}
	\item \textbf{Condition \texttt{If Left(cel.Value, 2) = "X\_"}} :
	\begin{itemize}
		\item \texttt{Left(cel.Value, 2)} extrait les deux premiers caractères de la chaîne.
		\item La condition vérifie si ces caractères correspondent à \texttt{"X\_"}.
		\item \texttt{Right(cel.Value, Len(cel.Value) - 2)} extrait les caractères restants après suppression des deux premiers.
	\end{itemize}
	\item \textbf{Condition \texttt{If Len(cel.Value) > 7}} :
	\begin{itemize}
		\item \texttt{Len(cel.Value)} calcule la longueur totale de la chaîne.
		\item Si cette longueur dépasse 7, les deux premiers caractères sont supprimés à l'aide de \texttt{Right}.
	\end{itemize}
\end{itemize}

\section{Applications pratiques}

Ce type de manipulation est utile pour :
\begin{itemize}
	\item Nettoyer des données textuelles avec des préfixes indésirables.
	\item Réduire la longueur des chaînes pour répondre à des contraintes spécifiques.
	\item Préparer des données textuelles pour des analyses ou transformations ultérieures.
\end{itemize}

\section{Résumé des fonctions utilisées}

\begin{itemize}
	\item \texttt{Left} : Extrait les premiers caractères d'une chaîne.
	\item \texttt{Right} : Extrait les derniers caractères d'une chaîne.
	\item \texttt{Mid} : Extrait une sous-chaîne d'une chaîne.
	\item \texttt{Len} : Renvoie la longueur totale d'une chaîne.
\end{itemize}

Ces fonctions, combinées avec des conditions comme \texttt{If}, permettent une manipulation efficace et ciblée des données textuelles en VBA.

\chapter{Classification des notes d'agence}

Ce chapitre présente une procédure et une fonction VBA permettant de classifier les notes d'une agence en différentes catégories qualitatives en fonction de leurs valeurs.

\section{Utilisation de \texttt{Select Case}}

La procédure suivante, \texttt{SignAg}, utilise une boucle et une structure conditionnelle \texttt{Select Case} pour attribuer une classification textuelle basée sur la note donnée.

\begin{lstlisting}[language=vbscript, caption={Procédure \texttt{SignAg}}]
	Sub SignAg()
	
	' Déclaration de variables
	Dim NoteAgence As String
	Dim SignNote As String
	Dim sh As Worksheet
	Dim i As Integer, Derligne As Integer
	
	' Définir la feuille de calcul
	Set sh = Sheets(4)
	
	' Identifier la dernière ligne de données
	Derligne = sh.Cells(200, 1).End(xlUp).Row
	
	' Boucle à travers chaque ligne pour analyser la note
	For i = 2 To Derligne
	
	NoteAgence = sh.Cells(i, 2).Value ' Lecture de la note dans la colonne B
	
	' Classification à l'aide de Select Case
	Select Case NoteAgence
	
	Case "AAA"
	SignNote = "Prime"
	
	Case "AA", "AA-", "AA+"
	SignNote = "High grade"
	
	Case "A", "A-", "A+"
	SignNote = "Upper medium grade"
	
	Case "BBB", "BBB-", "BBB+"
	SignNote = "Lower medium grade"
	
	Case Else
	SignNote = "Note indisponible"
	
	End Select
	
	' Stockage de la classification dans la colonne D
	sh.Cells(i, 4).Value = SignNote
	
	Next i
	
	End Sub
\end{lstlisting}

\subsection*{Explications}

\begin{itemize}
	\item \textbf{\texttt{Select Case}} : Permet de tester plusieurs cas pour une variable donnée.
	\item \textbf{\texttt{Case Else}} : Définit une action par défaut si aucun des cas spécifiés n'est rempli.
	\item Les résultats sont enregistrés dans la colonne \texttt{D} de la feuille.
\end{itemize}

\section{Utilisation de \texttt{IIf} dans une fonction personnalisée}

La fonction \texttt{SignNoteF} est une alternative compacte à la procédure \texttt{SignAg}. Elle utilise des expressions imbriquées \texttt{IIf} pour déterminer la classification.

\begin{lstlisting}[language=vbscript, caption={Fonction \texttt{SignNoteF}}]
	Function SignNoteF(NoteAg As String)
	
	SignNoteF = IIf(NoteAg = "AAA", "Prime", _
	IIf(NoteAg = "AA" Or NoteAg = "AA+" Or NoteAg = "AA-", "High grade", _
	IIf(NoteAg = "A" Or NoteAg = "A+" Or NoteAg = "A-", "Upper grade", _
	IIf(NoteAg = "BBB" Or NoteAg = "BBB+" Or NoteAg = "BBB-", "Lower Medium grade", _
	"NON DISPONIBLE"))))
	
	End Function
\end{lstlisting}

\subsection*{Explications}

\begin{itemize}
	\item \textbf{\texttt{IIf}} : Une fonction VBA qui retourne une valeur en fonction d'une condition.
	\item Les expressions \texttt{IIf} imbriquées remplacent la structure \texttt{Select Case}.
	\item La fonction retourne la classification correspondant à la note passée en paramètre.
\end{itemize}

\section{Applications pratiques}

Ces outils sont particulièrement utiles pour :
\begin{itemize}
	\item Classifier les notes d'une agence de manière automatique.
	\item Gérer des jeux de données volumineux.
	\item Fournir une vue synthétique des données dans une feuille Excel.
\end{itemize}

\section{Résumé des techniques utilisées}

\begin{itemize}
	\item \texttt{Select Case} : Simplifie la gestion des conditions multiples.
	\item \texttt{IIf} : Permet d'imbriquer des conditions dans une fonction unique.
	\item Boucles \texttt{For ... Next} : Automatisent l'application des règles sur plusieurs lignes.
\end{itemize}

Ces deux approches offrent des solutions flexibles pour le traitement de données textuelles dans Excel à l'aide de VBA.


\chapter{Les Fonctions Importées d'Excel}

\section{Théorie}
En VBA, il est possible d'utiliser une large gamme de fonctions natives d'Excel pour effectuer des calculs directement dans le code. Ces fonctions sont accessibles via l'objet \texttt{WorksheetFunction}, qui permet d'accéder aux fonctions Excel comme \texttt{VLookup}, \texttt{Sum}, \texttt{CountIf}, et bien d'autres.

Ces fonctions sont très utiles pour effectuer des calculs complexes ou des recherches de données directement dans le code VBA, sans avoir besoin de manipuler manuellement les cellules. Elles sont appelées de la manière suivante :
\begin{itemize}
	\item \texttt{WorksheetFunction.FonctionExcel(argument1, argument2, \dots)}
\end{itemize}

Les fonctions les plus courantes comprennent :
\begin{itemize}
	\item \texttt{VLookup} : Recherche une valeur dans une table et retourne une valeur correspondante.
	\item \texttt{Sum} : Additionne une plage de valeurs.
	\item \texttt{CountIf} : Compte les cellules qui satisfont à un critère spécifique.
	\item \texttt{Average} : Calcule la moyenne des valeurs dans une plage.
	\item \texttt{Max} et \texttt{Min} : Renvoient respectivement la valeur maximale et minimale d'une plage.
\end{itemize}

\section{Exemples}
\subsection{Exemple 1 : \texttt{VLookup}}
La fonction \texttt{VLookup} recherche une valeur dans la première colonne d'une plage et renvoie une valeur correspondante à partir d'une autre colonne.
\newpage
\begin{lstlisting}[language=VBScript]
	data.Cells(i, 5).Value = WorksheetFunction.VLookup(Mid(data.Cells(i, 1).Value, 5, 3), ref.Columns("A:C"), 3, False)
\end{lstlisting}

Cette ligne recherche une sous-chaîne dans la colonne A de la feuille \texttt{ref}, et retourne la valeur correspondante dans la troisième colonne de la plage \texttt{A:C}.

\subsection{Exemple 2 : \texttt{CountIf}}
La fonction \texttt{CountIf} compte le nombre de cellules dans une plage qui répondent à un critère spécifique.

\begin{lstlisting}[language=VBScript]
	data.Cells(i, 8).Value = WorksheetFunction.CountIf(Columns(4), data.Cells(i, 4).Value)
\end{lstlisting}

Ici, \texttt{CountIf} compte combien de fois la valeur de la cellule \texttt{D(i)} apparaît dans la colonne D.

\subsection{Exemple 3 : \texttt{Sum}}
La fonction \texttt{Sum} additionne les valeurs dans une plage de cellules.

\begin{lstlisting}[language=VBScript]
	.Cells(Derligne + 2, 7).Value = WorksheetFunction.Sum(.Range("G2:G" & Derligne))
\end{lstlisting}

Cette ligne additionne toutes les valeurs de la colonne G de la ligne 2 à la dernière ligne (\texttt{Derligne}), et place le résultat dans la cellule \texttt{G(Derligne + 2)}.

\subsection{Exemple 4 : \texttt{Average}}
La fonction \texttt{Average} calcule la moyenne des valeurs dans une plage de cellules.

\begin{lstlisting}[language=VBScript]
	data.Cells(i, 9).Value = WorksheetFunction.Average(data.Range("C2:C" & Derligne))
\end{lstlisting}

Cette ligne calcule la moyenne des valeurs dans la plage \texttt{C2:C(Derligne)} et place le résultat dans la cellule \texttt{I(i)}.

\subsection{Exemple 5 : \texttt{Max} et \texttt{Min}}
Les fonctions \texttt{Max} et \texttt{Min} renvoient respectivement la valeur maximale et minimale d'une plage.

\begin{lstlisting}[language=VBScript]
	data.Cells(i, 10).Value = WorksheetFunction.Max(data.Range("C2:C" & Derligne))
	data.Cells(i, 11).Value = WorksheetFunction.Min(data.Range("C2:C" & Derligne))
\end{lstlisting}

Les deux lignes ci-dessus retournent respectivement la valeur maximale et minimale de la plage \texttt{C2:C(Derligne)}.

	
	
	
	
\end{document}
